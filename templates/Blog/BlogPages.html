{% extends "index.html" %}
{% load static %}
{% block title %}
<title>{{ blog.title }}</title>
{% endblock title %}
{% block container %}
<a href="{% url 'blog' %}" class="btn btn-outline-secondary">Back</a>
{% block content %}
<div class="container py-4">
  <div class="row">
    <div class="col-lg-8 offset-lg-2">
      <div class="card">
        <div class="text-center">
          <img
            src="{{ blog.coverImage.url }}"
            class="card-img-top-3 text-center"
            height="400px"
            width="50%"
            alt="Blog Cover Image"
          />
        </div>
        <div class="card-body">
          <h1 class="card-title">{{ blog.title }}</h1>
          <p class="card-text text-muted">By {{ blog.author }}</p>
          <p class="card-text text-muted">Published: {{ blog.datetime }}</p>
          <hr />
          <p class="card-text">{{ blog.description|safe }}</p>
        </div>
      </div>
    </div>
  </div>
  <div class="row d-flex justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card shadow-0 border" style="background-color: #f0f2f5;">
        <div class="card-body p-4">

          {% if request.user.is_authenticated %}

          <form class="form-outline mb-4" action="{% url 'handleComment' %}" method="post">
            {% csrf_token %}
            <input type="text" id="addANote" name="comment" class="form-control" placeholder="Type comment..." />
            <input type="hidden" name="blog_id" value="{{ blog.id }}" />
            <input type="submit" class="btn btn-outline-primary mt-1"></input>
          </form>

          {% else %}

          <div>
            <a class="btn btn-success me-5 mx-4" href="{% url 'login' %}">
              Login
            </a>
            Please login to comment
          </div>
          {% endif %}


          <div class="card mb-4">
            <div class="card-body">

              {% if comments|length == 0 %}
              No comments
              {% else %}
              {% for comment in comments %}
              <div class="comment-container" id="comment-{{ comment.id }}">
                <div class="d-flex justify-content-between">
                  <div class="d-flex flex-row align-items-center">
                    <img src="https://mdbcdn.b-cdn.net/img/Photos/Avatars/img%20(4).webp" alt="avatar" width="25"
                      height="25" />
                      <p class="small mb-0 ms-2">{{ comment.user.username }}</p>
                    </div>
                    <div class"d-flex flex-row align-items-center">
                      <p>{{ comment.content }}</p>
                    </div>
                    <div class="d-flex flex-row align-items-right m-1">
                    <i id="upvote-icon-{{ comment.id }}" class="fas fa-arrow-up m-1" style="cursor:pointer" onclick="upvote({{ comment.id }})"></i>
                    <p id="upvotes-{{ comment.id }}" class="small text-muted mb-0">{{ comment.upvotes }}</p>
                    <i id="downvote-icon-{{ comment.id }}" class="fas fa-arrow-down m-1" style="cursor:pointer" onclick="downvote({{ comment.id }})"></i>
                    <p id="downvotes-{{ comment.id }}" class="small text-muted mb-0">{{ comment.downvotes }}</p>
                  </div> 
              </div>
              {% endfor %}
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  function upvote(commentId) {
    let upvoteIcon = document.getElementById(`upvote-icon-${commentId}`);
    let upvotesElement = document.getElementById(`upvotes-${commentId}`);

    upvoteIcon.style.color = "red";
    let upvotes = parseInt(upvotesElement.innerText);
    upvotesElement.innerText = upvotes + 1;

    // Make AJAX POST request to upvote_comment view
    $.ajax({
      type: "POST",
      url: "{% url 'upvote_comment' %}",
      data: {
        comment_id: commentId,
        csrfmiddlewaretoken: "{{ csrf_token }}"
      },
      success: function (response) {
        // Update upvotes count with the updated value from the server
        upvotesElement.innerText = response.upvotes;
      },
      error: function (xhr, status, error) {
        console.log(error);
      }
    });
  }

  function downvote(commentId) {
    let downvoteIcon = document.getElementById(`downvote-icon-${commentId}`);
    let downvotesElement = document.getElementById(`downvotes-${commentId}`);

    downvoteIcon.style.color = "red";
    let downvotes = parseInt(downvotesElement.innerText);
    downvotesElement.innerText = downvotes + 1;


    $.ajax({
      type: "POST",
      url: "{% url 'downvote_comment' %}",
      data: {
        comment_id: commentId,
        csrfmiddlewaretoken: "{{ csrf_token }}"
      },
      success: function (response) {
        downvotesElement.innerText = response.downvotes;
      },
      error: function (xhr, status, error) {
        console.log(error);
      }
    });
  }
</script>
{% endblock %}
{% endblock container %}
